<!DOCTYPE html>
<html>
  <head>
    <title>如何自动获取网络变化通知 - Litao.Me</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" media="screen" href="/stylesheets/screen.css" type="text/css" />
    
    
  </head>
  <body>
    <div id="page">
      <div id="header">
        <a href="/"><h1>Litao.Me</h1></a>
      </div>
      <div id="body">
        <h1>如何自动获取网络变化通知</h1>
        <div class="postdate">Posted on 23 Apr 2012</div>
<div class="post">
<p>当我们把网线插到计算机上时，WINDOWS任务栏的托盘图标都会更改相应的网络图标，拔掉也会有相应的处理。一直都对这个机制感兴趣，却不知道如何做，而且公司的某个产品也需要这么一个功能。昨天在家测试某个程序的时候，发现了其中一个线程的栈中有一个叫wininet!CheckForNetworkChange的函数，IDA分析了WINNET.DLL后，有了本文。</p>

<p>微软在WINDOWS VISTA之后提供了一个叫NLA(Network List Manager API)的接口，用于获取网络状态变化通知的一个接口。以COM技术实现。
主要导出的COM接口如下：</p>

<pre>
IEnumNetworkConnections
IEnumNetworks
INetwork
INetworkConnection
INetworkConnectionEvents
INetworkEvents
INetworkListManager
INetworkListManagerEvents
</pre>


<p>其中INetworkListManager是一个根对象，可以获取计算机是否连接到因特网(INetworkListManager->get_IsConnectedToInternet)。还可以查询有哪些可用的网络和连接.更关键的是INetworkListManagerEvents和INetworkEvents两个类。这两个类在MSDN文档里的描述如下：</p>

<pre>
is a message sink interface that a client implements to get overall machine state related events.
</pre>


<p>也就是说我们要自己实现这两个类。而回调的方式是通过COM技术中特有的机制IConnectionPoint来搞定。实现方式如下：</p>

<script src="https://gist.github.com/3747800.js"> </script>


<p>因为NLA API是WINDOWS VISTA之后才有的，对于WINDOWS XP是不兼容的，但是WINDOWS XP下有一个方法可以达到同样的效果，可以参考文章<a href="http://msdn.microsoft.com/en-us/library/ms700657(v=vs.85">Network Awareness in Windows XP</a>.aspx)，这个文章里的代码是C#的，其中关键的代码转换成C++:</p>

<script src="https://gist.github.com/3747803.js"> </script>


</div>
 
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>16 Sep 2012</span> - <a href="/2012/09/16/begin.html">新的开始</a></li>
    
      <li><span>25 Apr 2012</span> - <a href="/2012/04/25/open-registry-key-in-regedit-exe.html">Open registry key in regedit.exe</a></li>
    
      <li><span>19 Apr 2012</span> - <a href="/2012/04/19/analyze-dead-lock.html">一次死锁的分析</a></li>
    
      <li><span>05 Mar 2012</span> - <a href="/2012/03/05/use_declspec_thread_in_dll.html">Use __declspec(thread) in dll occured Exception</a></li>
    
      <li><span>12 Nov 2011</span> - <a href="/2011/11/12/Why-do-we-want-to-share.html">我们为什么要分享</a></li>
    
  </ul>
</div>


<br />
<br />
<hr />
<div id="comments">
  <h2>Comments</h2>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_identifier = "/2012/04/23/How-to-Get-Network-Change-automation.html";
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://eahydra.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=eahydra">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

      </div>
    </div>
  </body>
</html>
